// ==========================================
// 1. 설정값 입력 (본인의 키와 ID로 채워주세요)
// ==========================================
const GEMINI_API_KEY = '여기에_API_키_입력';
const SOURCE_FOLDER_ID = '런닝_업로드_폴더_ID';

// 모델명 (안정적인 버전)
const MODEL_NAME = 'gemini-flash-latest'; 
// ==========================================

function processAllImagesTogether() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const mainSheet = ss.getSheetByName('Main');
  const detailSheet = ss.getSheetByName('Detail');
  
  if (!mainSheet || !detailSheet) {
    console.log("❌ 에러: 시트 이름이 'Main'과 'Detail'인지 확인해주세요.");
    return;
  }

  const sourceFolder = DriveApp.getFolderById(SOURCE_FOLDER_ID);
  const destFolder = DriveApp.getFolderById(DEST_FOLDER_ID);
  const files = sourceFolder.getFiles();
  
  let imageParts = [];
  let processedFiles = [];

  while (files.hasNext()) {
    const file = files.next();
    const mimeType = file.getMimeType();
    if (mimeType.indexOf('image') !== -1) {
      try {
        const base64 = Utilities.base64Encode(file.getBlob().getBytes());
        imageParts.push({ "inline_data": { "mime_type": mimeType, "data": base64 } });
        processedFiles.push(file);
      } catch (e) {
        console.log("이미지 변환 오류: " + file.getName());
      }
    }
  }

  if (imageParts.length === 0) return; // 이미지 없으면 종료 (비용 0)

  // Gemini 호출
  const data = callGeminiAPI(imageParts);
  
  if (!data) return;

  try {
    // Run_ID 생성
    const runId = generateRunId(mainSheet, data.date); 
    
    // [Main 시트] 저장 (없으면 빈칸 처리)
    const note = (data.description || "") + " (자동입력)";
    mainSheet.appendRow([
      runId,
      data.date,
      data.distance,
      data.duration,
      data.pace,
      data.heart_rate || "", // 없으면 빈칸
      data.cadence || "",    // 없으면 빈칸
      data.shoes || "",
      note
    ]);

    // [Detail 시트] 저장 (구간별 케이던스 추가됨)
    if (data.laps && data.laps.length > 0) {
      const lapRows = data.laps.map(lap => [
        runId,
        data.date,
        lap.km,
        lap.pace,
        lap.hr || "",      // 구간 심박수 (없으면 빈칸)
        lap.cadence || ""  // ✅ 추가됨: 구간 케이던스 (없으면 빈칸)
      ]);
      
      // 열 개수(6개)에 맞춰서 입력
      detailSheet.getRange(detailSheet.getLastRow() + 1, 1, lapRows.length, 6).setValues(lapRows);
    }

    // 파일 삭제 (휴지통 이동)
    processedFiles.forEach(file => file.setTrashed(true));
    console.log(`✅ 성공! [Run_ID: ${runId}] 저장 완료`);

  } catch (e) {
    console.log("❌ 데이터 저장 중 에러: " + e.toString());
  }
}

function generateRunId(sheet, dateString) {
  let dateObj = dateString ? new Date(dateString) : new Date();
  if (isNaN(dateObj.getTime())) dateObj = new Date();

  const yy = dateObj.getFullYear().toString().slice(-2);
  const mm = ('0' + (dateObj.getMonth() + 1)).slice(-2);
  const dd = ('0' + dateObj.getDate()).slice(-2);
  const prefix = `${yy}${mm}${dd}`;

  const data = sheet.getRange("A:A").getValues();
  let maxSeq = 0;

  for (let i = 1; i < data.length; i++) {
    const id = String(data[i][0]);
    if (id.startsWith(prefix)) {
      const seq = parseInt(id.replace(prefix, '')) || 0;
      if (seq > maxSeq) maxSeq = seq;
    }
  }
  return prefix + (maxSeq + 1);
}

function callGeminiAPI(imageParts) {
  const today = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd");

  const promptText = `
    이 이미지들은 런닝 앱 기록이야. JSON으로만 답해.
    
    [날짜 기준]
    - 오늘 날짜는 "${today}" 이다. 
    - 'Today', '오늘' -> "${today}"
    - 'Yesterday', '어제' -> 하루 전 날짜 계산 (YYYY-MM-DD)

    [데이터 추출 규칙]
    1. 데이터가 이미지에 없거나 불확실하면 숫자 0 대신 null 또는 빈 문자열("")을 반환해.
    2. '구간 기록(Lap)' 표에서 '심박수'와 '케이던스(spm)'도 함께 추출해.
    
    [JSON 형식]
    {
      "date": "YYYY-MM-DD",
      "distance": "숫자만", "duration": "HH:MM:SS", "pace": "MM'SS''",
      "heart_rate": "숫자(없으면 null)", "cadence": "숫자(없으면 null)", 
      "shoes": "텍스트", "description": "텍스트",
      "laps": [
        { 
          "km": 1, 
          "pace": "MM'SS''", 
          "hr": "숫자(없으면 null)", 
          "cadence": "숫자(없으면 null)" 
        }
      ]
    }
  `;

  const payload = {
    "contents": [{ "parts": [{ "text": promptText }, ...imageParts] }]
  };

  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;

  try {
    const response = UrlFetchApp.fetch(url, {
      "method": "post",
      "contentType": "application/json",
      "payload": JSON.stringify(payload),
      "muteHttpExceptions": true
    });

    if (response.getResponseCode() !== 200) {
      console.log(`❌ API 에러: ${response.getContentText()}`);
      return null;
    }

    const text = JSON.parse(response.getContentText()).candidates[0].content.parts[0].text;
    return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());

  } catch (e) {
    console.log("❌ 분석 에러: " + e.toString());
    return null;
  }
}