const GEMINI_API_KEY = â€˜Google API Keyâ€™;
const SOURCE_FOLDER_ID = â€˜RunningResults IDâ€™;
const DEST_FOLDER_ID = 'RunningArchive IDâ€™;

// âœ… ë¡œê·¸ì—ì„œ í™•ì¸ëœ 'ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ëª…'ìœ¼ë¡œ í™•ì •
const MODEL_NAME = 'gemini-flash-latest'; 
// ==========================================

function processAllImagesTogether() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const mainSheet = ss.getSheetByName('Main');
  const detailSheet = ss.getSheetByName('Detail');
  
  // ì‹œíŠ¸ ì´ë¦„ í™•ì¸
  if (!mainSheet || !detailSheet) {
    console.log("âŒ ì—ëŸ¬: ì‹œíŠ¸ ì´ë¦„ì´ 'Main'ê³¼ 'Detail'ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
    return;
  }

  const sourceFolder = DriveApp.getFolderById(SOURCE_FOLDER_ID);
  const destFolder = DriveApp.getFolderById(DEST_FOLDER_ID);
  const files = sourceFolder.getFiles();
  
  let imageParts = [];
  let processedFiles = [];

  // í´ë”ì—ì„œ ì´ë¯¸ì§€ ìˆ˜ì§‘
  while (files.hasNext()) {
    const file = files.next();
    const mimeType = file.getMimeType();
    if (mimeType.indexOf('image') !== -1) {
      try {
        const base64 = Utilities.base64Encode(file.getBlob().getBytes());
        imageParts.push({ "inline_data": { "mime_type": mimeType, "data": base64 } });
        processedFiles.push(file);
      } catch (e) {
        console.log("ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜(íŒŒì¼ ê±´ë„ˆëœ€): " + file.getName());
      }
    }
  }

  // ì²˜ë¦¬í•  ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
  if (imageParts.length === 0) {
    console.log("ğŸ“‚ í´ë”ì— ì²˜ë¦¬í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // Gemini í˜¸ì¶œ
  const data = callGeminiAPI(imageParts);
  
  if (!data) return; // ì—ëŸ¬ë‚˜ë©´ ì¢…ë£Œ

  try {
    // Run_ID ìƒì„± (ìë™ ì¦ê°€)
    const runId = generateRunId(mainSheet, data.date); 
    
    // [Main ì‹œíŠ¸] ì €ì¥
    const note = (data.description || "");
    mainSheet.appendRow([
      runId, data.date, data.distance, data.duration, 
      data.pace, data.heart_rate, data.cadence, data.shoes, note
    ]);

    // [Detail ì‹œíŠ¸] ì €ì¥
    if (data.laps && data.laps.length > 0) {
      const lapRows = data.laps.map(lap => [
        runId, data.date, lap.km, lap.pace, lap.hr || ""
      ]);
      detailSheet.getRange(detailSheet.getLastRow() + 1, 1, lapRows.length, 5).setValues(lapRows);
    }

    // ì²˜ë¦¬ëœ íŒŒì¼ ì´ë™
    processedFiles.forEach(file => file.moveTo(destFolder));
    console.log(`âœ… ì„±ê³µ! [Run_ID: ${runId}] ë°ì´í„°ê°€ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

  } catch (e) {
    console.log("âŒ ë°ì´í„° ì‹œíŠ¸ ì €ì¥ ì¤‘ ì—ëŸ¬: " + e.toString());
  }
}

// ID ìƒì„± í•¨ìˆ˜
function generateRunId(sheet, dateString) {
  let dateObj = dateString ? new Date(dateString) : new Date();
  if (isNaN(dateObj.getTime())) dateObj = new Date();

  const yy = dateObj.getFullYear().toString().slice(-2);
  const mm = ('0' + (dateObj.getMonth() + 1)).slice(-2);
  const dd = ('0' + dateObj.getDate()).slice(-2);
  const prefix = `${yy}${mm}${dd}`;

  const data = sheet.getRange("A:A").getValues();
  let maxSeq = 0;

  for (let i = 1; i < data.length; i++) {
    const id = String(data[i][0]);
    if (id.startsWith(prefix)) {
      const seq = parseInt(id.replace(prefix, '')) || 0;
      if (seq > maxSeq) maxSeq = seq;
    }
  }
  return prefix + (maxSeq + 1);
}

// API í˜¸ì¶œ í•¨ìˆ˜
function callGeminiAPI(imageParts) {
  const today = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd");
  const promptText =`
    ì´ ì´ë¯¸ì§€ë“¤ì€ ëŸ°ë‹ ì•± ê¸°ë¡ì´ì•¼. JSONìœ¼ë¡œë§Œ ë‹µí•´.
    
    [ì¤‘ìš”: ë‚ ì§œ ê³„ì‚°]
    - ì˜¤ëŠ˜ ë‚ ì§œ(ê¸°ì¤€ì¼)ëŠ” "${today}" ì´ë‹¤.
    - ë§Œì•½ ì´ë¯¸ì§€ì— 'Today', 'ì˜¤ëŠ˜'ì´ë¼ê³  ì í˜€ ìˆìœ¼ë©´ "${today}"ë¥¼ ë‚ ì§œë¡œ ì‚¬ìš©í•´.
    - ë§Œì•½ ì´ë¯¸ì§€ì— 'Yesterday', 'ì–´ì œ'ë¼ê³  ì í˜€ ìˆìœ¼ë©´ í•˜ë£¨ ì „ ë‚ ì§œë¥¼ ê³„ì‚°í•´ì„œ "YYYY-MM-DD" í˜•ì‹ìœ¼ë¡œ ì ì–´.
    - ë§Œì•½ ìš”ì¼ë§Œ ì í˜€ ìˆë‹¤ë©´(ì˜ˆ: 'Sunday'), ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ìµœê·¼ì˜ í•´ë‹¹ ìš”ì¼ì„ ê³„ì‚°í•´.

    [ì¶”ì¶œ í•­ëª©]
    1. ìš”ì•½ ì •ë³´(ê±°ë¦¬, ì‹œê°„, í˜ì´ìŠ¤, ì‹¬ë°•, ì¼€ì´ë˜ìŠ¤) ì¶”ì¶œí•´.
    2. 'êµ¬ê°„ ê¸°ë¡(Lap)' í‘œê°€ ë³´ì´ë©´ 1km ë‹¨ìœ„ ìƒì„¸ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë§Œë“¤ì–´.
    3. ë©”ëª¨ë‚˜ ì œëª©ì´ ë³´ì´ë©´ descriptionì— ë„£ì–´.
    
    JSON í˜•ì‹:
    {
      "date": "YYYY-MM-DD (ë°˜ë“œì‹œ ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜)",
      "distance": "ìˆ«ìë§Œ", "duration": "HH:MM:SS", "pace": "MM'SS''",
      "heart_rate": "ìˆ«ì", "cadence": "ìˆ«ì", "shoes": "í…ìŠ¤íŠ¸", "description": "í…ìŠ¤íŠ¸",
      "laps": [{ "km": 1, "pace": "MM'SS''", "hr": "ìˆ«ì" }]
    }
  `;

  const payload = {
    "contents": [{ "parts": [{ "text": promptText }, ...imageParts] }]
  };

  // âœ… í™•ì¸ëœ ëª¨ë¸ëª… ì‚¬ìš©
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;

  try {
    const response = UrlFetchApp.fetch(url, {
      "method": "post",
      "contentType": "application/json",
      "payload": JSON.stringify(payload),
      "muteHttpExceptions": true
    });

    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();

    if (responseCode !== 200) {
      console.log(`âŒ API í˜¸ì¶œ ì‹¤íŒ¨ (ì½”ë“œ ${responseCode})`);
      console.log(`ì—ëŸ¬ ë‚´ìš©: ${responseText}`);
      return null;
    }

    const resultJson = JSON.parse(responseText);
    const text = resultJson.candidates[0].content.parts[0].text;
    return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());

  } catch (e) {
    console.log("âŒ ë¶„ì„ í•¨ìˆ˜ ë‚´ë¶€ ì—ëŸ¬: " + e.toString());
    return null;
  }
}
